(function(h,p){typeof exports=="object"&&typeof module<"u"?p(exports):typeof define=="function"&&define.amd?define(["exports"],p):(h=typeof globalThis<"u"?globalThis:h||self,p(h.Game={}))})(this,function(h){"use strict";const f=SWIDTH/2,_=SHEIGHT/2,g=8,E=SHEIGHT-8,A=12,L=4,v=1,D=.1,O=.25,l=2,R=[45,-45,135,225],N=1,V=1.05,S=99,I=tmap("tilemap"),T=fnt("MoroboxAIRetro"),G=[{reaction:.2,error:40},{reaction:.3,error:50},{reaction:.4,error:60},{reaction:.5,error:70},{reaction:.6,error:80},{reaction:.7,error:90},{reaction:.8,error:100},{reaction:.9,error:110},{reaction:1,error:120},{reaction:1.1,error:130},{reaction:1.2,error:140},{reaction:1.3,error:150},{reaction:1.4,error:160},{reaction:1.5,error:170},{reaction:1.6,error:180},{reaction:1.7,error:190},{reaction:1.8,error:200}],X=8;class B{constructor(t,e){this.x=0,this.y=0,this.width=t,this.height=e}get hwidth(){return this.width/2}get hheight(){return this.height/2}get left(){return this.x-this.hwidth}get right(){return this.x+this.hwidth}get top(){return this.y-this.hheight}get bottom(){return this.y+this.hheight}saveState(){throw new Error("state must be implemented")}loadState(t){throw new Error("state must be implemented")}update(t){throw new Error("update must be implemented")}draw(){throw new Error("draw must be implemented")}}class M extends B{constructor(t,e,o){super(e,o),this._controller=t}saveState(){return{x:this.x,y:this.y}}loadState(t){this.x=t.x,this.y=t.y}update(t){const e=this._controller.inputs();e.up?this.y-=v*t:e.down&&(this.y+=v*t),this.y<g+this.hheight?this.y=g+this.hheight:this.y>E-this.hheight&&(this.y=E-this.hheight)}draw(){sclear(),stile(I,0,0,1,2),sorigin(4,8),sdraw(this.x,this.y)}}class j extends B{constructor(t){super(t,t),this.direction={x:0,y:0},this.speed=0}saveState(){return{x:this.x,y:this.y}}loadState(t){this.x=t.x,this.y=t.y}get radius(){return this.hwidth}update(t){this.x+=this.direction.x*this.speed*t,this.y+=this.direction.y*this.speed*t,this.y<g+this.hheight?(this.y=g+this.hheight,this.direction.y*=-1):this.y>E-this.hheight&&(this.y=E-this.hheight,this.direction.y*=-1)}draw(){sclear(),stile(I,1,0,1,1),sorigin(4,4),sdraw(this.x,this.y)}}function P(i,t,e,o){let n;return e<0?n=y(i.x,i.y,i.x+e,i.y+o,t.right+i.radius,t.top-i.radius,t.right+i.radius,t.bottom+i.radius,"right"):e>0&&(n=y(i.x,i.y,i.x+e,i.y+o,t.left-i.radius,t.top-i.radius,t.left-i.radius,t.bottom+i.radius,"left")),n||(o<0&&(n=y(i.x,i.y,i.x+e,i.y+o,t.left-i.radius,t.bottom+i.radius,t.right+i.radius,t.bottom+i.radius,"bottom")),o>0&&(n=y(i.x,i.y,i.x+e,i.y+o,t.left-i.radius,t.top-i.radius,t.right+i.radius,t.top-i.radius,"top"))),n}function y(i,t,e,o,n,a,H,Y,b){var m=(Y-a)*(e-i)-(H-n)*(o-t);if(m!=0){var w=((H-n)*(t-a)-(Y-a)*(i-n))/m;if(w>=0&&w<=1){var k=((e-i)*(t-a)-(o-t)*(i-n))/m;if(k>=0&&k<=1){var tt=i+w*(e-i),it=t+w*(o-t);return{x:tt,y:it,d:b}}}}return null}class C{constructor(t){this._pid=t,this.score=0}get pid(){return this._pid}get label(){return"human"}sendState(t){state(this._pid,t)}inputs(){return{left:btn(this._pid,BLEFT),right:btn(this._pid,BRIGHT),up:btn(this._pid,BUP),down:btn(this._pid,BDOWN)}}}class $ extends C{constructor(t){super(t),this._inputs={},this._prediction=void 0,this._level=X}get label(){return"ai"}sendState(t){state(this.pid,t)}inputs(){return this.isBound?super.inputs():this._inputs}_predict(t,e,o){if(this._prediction&&this._prediction.dX*e.direction.x>0&&this._prediction.dY*e.direction.y>0&&this._prediction.since<G[this._level].reaction){this._prediction.since+=o;return}const n=P(e,{left:t.left,right:t.right,top:-1e4,bottom:1e4},e.direction.x*SWIDTH,e.direction.y*SWIDTH);if(n){this._prediction={dX:e.direction.x,dY:e.direction.y,y:n.y,since:0};const a=(e.direction.x<0?e.x-t.right:t.left-e.x)/SWIDTH,H=G[this._level].error*a;this._prediction.y=this._prediction.y+(Math.random()*2-1)*H}else{this._prediction=void 0;return}}update(t,e,o){this._inputs.up=!1,this._inputs.down=!1,!(e.x<t.x&&e.direction.x<0||e.x>t.x&&e.direction.x>0)&&(this._predict(t,e,o),this._prediction&&(this._prediction.y<t.y-t.height*O?(this._inputs.up=!0,this._inputs.down=!1):this._prediction.y>t.y+t.height*O&&(this._inputs.up=!1,this._inputs.down=!0)))}}var W=(i=>(i[i.PLAY=0]="PLAY",i[i.GAME_OVER=1]="GAME_OVER",i))(W||{});const c=new C(P1),d=new $(P2),r={left:new M(c,L,A),right:new M(d,L,A)},s=new j(l);let u=0;function x(){u=0,r.left.x=SWIDTH*D,r.left.y=_,r.right.x=SWIDTH-SWIDTH*D,r.right.y=_,s.x=f,s.y=_;const i=R[floor(Math.random()*R.length)]*Math.PI/180;s.direction.x=cos(i),s.direction.y=sin(i),s.speed=N}function F(i,t){const e=P(t,i,t.direction.x*t.speed,t.direction.y*t.speed);if(e){switch(e.d){case"left":case"right":t.x=e.x,t.direction.x*=-1;break;case"top":case"bottom":t.y=e.y,t.direction.y*=-1;break}t.speed*=V}}function Z(i){u!==1&&(d.update(r.right,s,i),r.left.update(i),r.right.update(i),s.update(i),s.direction.x<0?F(r.left,s):F(r.right,s),(s.x<0||s.x>SWIDTH)&&(s.x<0?d.score=min(d.score+1,S):c.score=min(c.score+1,S),x(),(d.score===S||c.score===S)&&(u=1)))}function U(i){const t=i.pid===P1,e=i.label.toUpperCase();falign(t?0:1,0),fdraw(T,t?`P1:${e}`:`${e}:P2`,t?2:SWIDTH-1,2),falign(t?1:0,0),fdraw(T,i.score.toString(),f+(t?-2:2),2)}function q(){clear(9153551),camera(f,_),r.left.draw(),r.right.draw(),s.draw(),sclear(),sscale(SWIDTH/8,8/8),stile(I,2,1,1,1),sdraw(0,0),sdraw(0,SHEIGHT-8),fclear(),fcolor(3170864),falign(.5,0),fdraw(T,"-",f,2),U(c),U(d)}x();function J(i){Z(i),q()}function K(){return{isGameOver:u===1,mode:u,scores:[c.score,d.score],bars:[r.left.saveState(),r.right.saveState()],ball:s.saveState()}}function Q(i){if(i===void 0){x();return}u=i.mode,c.score=i.scores[0],d.score=i.scores[1],r.left.loadState(i.bars[0]),r.right.loadState(i.bars[1]),s.loadState(i.ball)}function z(){return{bars:[r.left.saveState(),r.right.saveState()],ball:s.saveState()}}h.EGameMode=W,h.getStateForAgent=z,h.loadState=Q,h.saveState=K,h.tick=J,Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
