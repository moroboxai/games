(function(h,a){typeof exports=="object"&&typeof module<"u"?a(exports):typeof define=="function"&&define.amd?define(["exports"],a):(h=typeof globalThis<"u"?globalThis:h||self,a(h.Game={}))})(this,function(h){"use strict";const p=SWIDTH/2,f=SHEIGHT/2,_=8,g=SHEIGHT-8,m=12,A=4,L=1,v=.1,D=.25,l=2,O=[45,-45,135,225],N=1,V=1.05,R=99,w=tmap("tilemap"),I=fnt("MoroboxAIRetro"),G=[{reaction:.2,error:40},{reaction:.3,error:50},{reaction:.4,error:60},{reaction:.5,error:70},{reaction:.6,error:80},{reaction:.7,error:90},{reaction:.8,error:100},{reaction:.9,error:110},{reaction:1,error:120},{reaction:1.1,error:130},{reaction:1.2,error:140},{reaction:1.3,error:150},{reaction:1.4,error:160},{reaction:1.5,error:170},{reaction:1.6,error:180},{reaction:1.7,error:190},{reaction:1.8,error:200}],X=8;class B{constructor(t,e){this.x=0,this.y=0,this.width=t,this.height=e}get hwidth(){return this.width/2}get hheight(){return this.height/2}get left(){return this.x-this.hwidth}get right(){return this.x+this.hwidth}get top(){return this.y-this.hheight}get bottom(){return this.y+this.hheight}saveState(){throw new Error("state must be implemented")}loadState(t){throw new Error("state must be implemented")}update(t){throw new Error("update must be implemented")}draw(){throw new Error("draw must be implemented")}}class M extends B{constructor(t,e,o){super(e,o),this._controller=t}saveState(){return{x:this.x,y:this.y}}loadState(t){this.x=t.x,this.y=t.y}update(t){const e=this._controller.inputs();e.up?this.y-=L*t:e.down&&(this.y+=L*t),this.y<_+this.hheight?this.y=_+this.hheight:this.y>g-this.hheight&&(this.y=g-this.hheight)}draw(){sclear(),stile(w,0,0,1,2),sorigin(4,8),sdraw(this.x,this.y)}}class j extends B{constructor(t){super(t,t),this.direction={x:0,y:0},this.speed=0}saveState(){return{x:this.x,y:this.y}}loadState(t){this.x=t.x,this.y=t.y}get radius(){return this.hwidth}update(t){this.x+=this.direction.x*this.speed*t,this.y+=this.direction.y*this.speed*t,this.y<_+this.hheight?(this.y=_+this.hheight,this.direction.y*=-1):this.y>g-this.hheight&&(this.y=g-this.hheight,this.direction.y*=-1)}draw(){sclear(),stile(w,1,0,1,1),sorigin(4,4),sdraw(this.x,this.y)}}function P(i,t,e,o){let n;return e<0?n=E(i.x,i.y,i.x+e,i.y+o,t.right+i.radius,t.top-i.radius,t.right+i.radius,t.bottom+i.radius,"right"):e>0&&(n=E(i.x,i.y,i.x+e,i.y+o,t.left-i.radius,t.top-i.radius,t.left-i.radius,t.bottom+i.radius,"left")),n||(o<0&&(n=E(i.x,i.y,i.x+e,i.y+o,t.left-i.radius,t.bottom+i.radius,t.right+i.radius,t.bottom+i.radius,"bottom")),o>0&&(n=E(i.x,i.y,i.x+e,i.y+o,t.left-i.radius,t.top-i.radius,t.right+i.radius,t.top-i.radius,"top"))),n}function E(i,t,e,o,n,u,y,Y,b){var x=(Y-u)*(e-i)-(y-n)*(o-t);if(x!=0){var H=((y-n)*(t-u)-(Y-u)*(i-n))/x;if(H>=0&&H<=1){var k=((e-i)*(t-u)-(o-t)*(i-n))/x;if(k>=0&&k<=1){var tt=i+H*(e-i),it=t+H*(o-t);return{x:tt,y:it,d:b}}}}return null}class C{constructor(t){this._pid=t,this.score=0}get pid(){return this._pid}get label(){return"human"}sendState(t){state(this._pid,t)}inputs(){return{left:btn(this._pid,BLEFT),right:btn(this._pid,BRIGHT),up:btn(this._pid,BUP),down:btn(this._pid,BDOWN)}}}class $ extends C{constructor(t){super(t),this._inputs={},this._prediction=void 0,this._level=X}get label(){return"ai"}sendState(t){state(this.pid,t)}inputs(){return this.isBound?super.inputs():this._inputs}_predict(t,e,o){if(this._prediction&&this._prediction.dX*e.direction.x>0&&this._prediction.dY*e.direction.y>0&&this._prediction.since<G[this._level].reaction){this._prediction.since+=o;return}const n=P(e,{left:t.left,right:t.right,top:-1e4,bottom:1e4},e.direction.x*SWIDTH,e.direction.y*SWIDTH);if(n){this._prediction={dX:e.direction.x,dY:e.direction.y,y:n.y,since:0};const u=(e.direction.x<0?e.x-t.right:t.left-e.x)/SWIDTH,y=G[this._level].error*u;this._prediction.y=this._prediction.y+(Math.random()*2-1)*y}else{this._prediction=void 0;return}}update(t,e,o){this._inputs.up=!1,this._inputs.down=!1,!(e.x<t.x&&e.direction.x<0||e.x>t.x&&e.direction.x>0)&&(this._predict(t,e,o),this._prediction&&(this._prediction.y<t.y-t.height*D?(this._inputs.up=!0,this._inputs.down=!1):this._prediction.y>t.y+t.height*D&&(this._inputs.up=!1,this._inputs.down=!0)))}}var W=(i=>(i[i.PLAY=0]="PLAY",i[i.GAME_OVER=1]="GAME_OVER",i))(W||{});const c=new C(P1),d=new $(P2),r={left:new M(c,A,m),right:new M(d,A,m)},s=new j(l);let S=0;function T(){S=0,r.left.x=SWIDTH*v,r.left.y=f,r.right.x=SWIDTH-SWIDTH*v,r.right.y=f,s.x=p,s.y=f;const i=O[floor(Math.random()*O.length)]*Math.PI/180;s.direction.x=cos(i),s.direction.y=sin(i),s.speed=N}function F(i,t){const e=P(t,i,t.direction.x*t.speed,t.direction.y*t.speed);if(e){switch(e.d){case"left":case"right":t.x=e.x,t.direction.x*=-1;break;case"top":case"bottom":t.y=e.y,t.direction.y*=-1;break}t.speed*=V}}function Z(i){d.update(r.right,s,i),r.left.update(i),r.right.update(i),s.update(i),s.direction.x<0?F(r.left,s):F(r.right,s),(s.x<0||s.x>SWIDTH)&&(s.x<0?d.score=min(d.score+1,R):c.score=min(c.score+1,R),T())}function U(i){const t=i.pid===P1,e=i.label.toUpperCase();falign(t?0:1,0),fdraw(I,t?`P1:${e}`:`${e}:P2`,t?2:SWIDTH-1,2),falign(t?1:0,0),fdraw(I,i.score.toString(),p+(t?-2:2),2)}function q(){clear(9153551),camera(p,f),r.left.draw(),r.right.draw(),s.draw(),sclear(),sscale(SWIDTH/8,8/8),stile(w,2,1,1,1),sdraw(0,0),sdraw(0,SHEIGHT-8),fclear(),fcolor(3170864),falign(.5,0),fdraw(I,"-",p,2),U(c),U(d)}T();function J(i){Z(i),q()}function K(){return{isGameOver:S===1,mode:S,scores:[c.score,d.score],bars:[r.left.saveState(),r.right.saveState()],ball:s.saveState()}}function Q(i){if(i===void 0){T();return}S=i.mode,c.score=i.scores[0],d.score=i.scores[1],r.left.loadState(i.bars[0]),r.right.loadState(i.bars[1]),s.loadState(i.ball)}function z(){return{bars:[r.left.saveState(),r.right.saveState()],ball:s.saveState()}}h.EGameMode=W,h.getStateForAgent=z,h.loadState=Q,h.saveState=K,h.tick=J,Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
